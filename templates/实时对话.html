<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>实时对话界面 - DATA HAMMER GROUP</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    body { font-family: 'Microsoft YaHei', sans-serif; margin: 0; }
    body.main-bg {
      background: radial-gradient(circle at top, #05070a 0%, #050608 35%, #000000 100%);
      color: #fff; min-height: 100vh; display: flex; flex-direction: column;
    }
    .nav { display:flex; align-items:center; justify-content:space-between; padding:14px 32px;
      border-bottom:1px solid rgba(255,255,255,0.08); backdrop-filter: blur(12px);
      background: linear-gradient(90deg, rgba(0,229,255,0.18), rgba(0,0,0,0.6), rgba(0,229,255,0.08));
      position: sticky; top: 0; z-index: 20;
    }
    .nav-logo { display:flex; align-items:center; gap:10px; }
    .nav-logo-mark { width:26px; height:26px; border-radius:10px;
      background: conic-gradient(from 200deg, #00e5ff, #0072ff, #00ffbf, #00e5ff);
      box-shadow: 0 0 18px rgba(0,229,255,0.8); position:relative;
    }
    .nav-logo-mark::after { content:""; position:absolute; inset:4px; border-radius:8px;
      background: radial-gradient(circle at 30% 20%, #0b1b26, #020509);
    }
    .nav-logo-text-main { font-size:1.05rem; letter-spacing:0.12em; }
    .nav-logo-text-sub { font-size:0.75rem; opacity:0.6; }
    .nav-links { display:flex; gap:22px; font-size:0.95rem; }
    .nav-links a { color:rgba(255,255,255,0.75); text-decoration:none; position:relative; padding-bottom:4px; cursor:pointer; }
    .nav-links a::after { content:""; position:absolute; left:0; bottom:0; width:0; height:2px; border-radius:999px;
      background:linear-gradient(90deg, #00e5ff, #00ffbf); transition: width .25s ease;
    }
    .nav-links a:hover::after { width:100%; }
    .nav-cta { padding:8px 18px; border-radius:999px; border:1px solid rgba(0,229,255,0.5);
      background: radial-gradient(circle at 0 0, rgba(0,229,255,0.35), transparent);
      font-size:0.9rem; cursor:pointer; color:#e6faff; transition:all .25s ease;
    }
    .nav-cta:hover { transform: translateY(-1px); box-shadow:0 0 18px rgba(0,229,255,0.45);
      background: radial-gradient(circle at 100% 0, rgba(0,229,255,0.5), transparent);
    }
    @media (max-width:960px){ .nav{ padding:10px 16px; } }

    .page-wrapper{ flex:1; display:flex; justify-content:center; padding:24px 16px 24px; }
    .page-inner{ width:100%; max-width:980px; display:flex; flex-direction:column; gap:18px; margin:0 auto; }

    .hero-card{
      background: radial-gradient(circle at top left, rgba(0,229,255,0.18), transparent 55%), rgba(255,255,255,0.02);
      border-radius:18px; padding:22px 20px 20px; border:1px solid rgba(255,255,255,0.14);
      box-shadow:0 0 30px rgba(0,229,255,0.18), 0 0 90px rgba(0,0,0,0.85);
      backdrop-filter: blur(12px); position:relative; overflow:hidden; margin:0 auto; width:100%; text-align:center;
    }
    .hero-card::before{
      content:"DATA • HAMMER • REALTIME • TALKING"; position:absolute; top:10px; right:-40px;
      font-size:0.65rem; letter-spacing:0.35em; color:rgba(255,255,255,0.08); transform: rotate(-6deg); white-space:nowrap;
    }
    .badge{ display:inline-flex; align-items:center; gap:8px; padding:4px 10px; border-radius:999px;
      background:rgba(0,0,0,0.45); border:1px solid rgba(0,229,255,0.5); font-size:0.75rem; color:#cfefff; margin-bottom:14px;
    }
    .badge-dot{ width:7px; height:7px; border-radius:999px; background: radial-gradient(circle, #00ffbf, #00e5ff);
      box-shadow:0 0 10px rgba(0,229,255,0.9);
    }
    .headline{ font-size:1.8rem; margin:0 0 10px; letter-spacing:0.08em; }
    .headline span{ color:#00e5ff; }
    .subline{ font-size:0.92rem; color:rgba(226,244,255,0.85); max-width:720px; line-height:1.7; margin:0 auto 4px; text-align:center; }
    .status-pill{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px;
      font-size:0.78rem; color:#cfefff; background:rgba(0,0,0,0.55); border:1px solid rgba(0,229,255,0.45); margin-top:6px;
    }
    .status-dot{ width:7px; height:7px; border-radius:999px; background:#ff4b6a; box-shadow:0 0 8px rgba(255,75,106,0.8); }
    .status-dot.online{ background:#00ffbf; box-shadow:0 0 8px rgba(0,255,191,0.8); }

    .video-page-container{
      display:flex; gap:18px;
      background: radial-gradient(circle at top left, rgba(0,229,255,0.18), transparent 55%), rgba(255,255,255,0.03);
      border-radius:18px; padding:18px; border:1px solid rgba(255,255,255,0.14);
      box-shadow:0 0 30px rgba(0,229,255,0.18), 0 0 90px rgba(0,0,0,0.85);
      backdrop-filter: blur(14px); width:100%; max-width:980px; margin:0 auto;
    }
    @media (max-width:900px){ .video-page-container{ flex-direction:column; } }

    .dialog-display{ flex:1.1; padding:10px; display:flex; flex-direction:column; gap:10px; }
    .dialog-card{
      background:rgba(5,10,20,0.9); border-radius:14px; border:1px solid rgba(255,255,255,0.14);
      padding:12px 12px 10px; box-shadow:0 0 20px rgba(0,229,255,0.15); height:260px; display:flex; flex-direction:column;
    }
    .dialog-card-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;
      font-size:0.86rem; color:rgba(220,236,255,0.9); }
    .chat-log{ flex:1; overflow-y:auto; padding-right:4px; font-size:0.86rem; }
    .chat-msg{ margin-bottom:6px; line-height:1.5; }
    .chat-msg span.role{ display:inline-block; min-width:46px; font-size:0.78rem; padding:1px 8px; border-radius:999px; margin-right:4px; }
    .chat-msg.user span.role{ background:rgba(0,229,255,0.2); color:#9be9ff; }
    .chat-msg.assistant span.role{ background:rgba(0,255,191,0.18); color:#b6ffe5; }
    .chat-msg.system span.role{ background:rgba(255,255,255,0.08); color:#e0edff; }
    .chat-msg .content{ color:rgba(235,245,255,0.92); }
    .small-hint{ font-size:0.78rem; color:rgba(200,220,240,0.7); margin-top:4px; }

    .form-section{ flex:0.9; padding:16px 18px; background:rgba(5,10,20,0.92);
      border-radius:14px; border:1px solid rgba(255,255,255,0.12); box-shadow:0 0 20px rgba(0,229,255,0.15);
    }
    .form-group{ margin-bottom:12px; }
    label{ display:block; margin-bottom:6px; font-weight:500; color:rgba(230,243,255,0.9); font-size:0.9rem; }
    input, textarea{
      width:100%; padding:9px 10px; border:1px solid rgba(255,255,255,0.15); border-radius:8px;
      font-size:0.9rem; box-sizing:border-box; background:rgba(0,0,0,0.35); color:#eaf6ff; outline:none; resize:vertical;
    }
    input:focus, textarea:focus{ border-color:#00e5ff; box-shadow:0 0 0 1px rgba(0,229,255,0.4); }
    textarea{ min-height:70px; max-height:140px; }
    .btn-row{ display:flex; gap:10px; margin-top:2px; }
    .primary-btn, .secondary-btn{ flex:1; padding:9px; border-radius:999px; border:none; font-size:0.9rem; cursor:pointer; transition:all .25s ease; }
    .primary-btn{ background:linear-gradient(120deg, #00c6ff, #0072ff); color:#fff; box-shadow:0 0 16px rgba(0,229,255,0.4); }
    .primary-btn:hover{ background:linear-gradient(120deg, #0072ff, #00e5ff); transform:translateY(-1px); box-shadow:0 0 22px rgba(0,229,255,0.7); }
    .secondary-btn{ background:rgba(0,0,0,0.4); color:rgba(230,243,255,0.9); border:1px solid rgba(255,255,255,0.2); }
    .secondary-btn:hover{ background:rgba(15,25,40,0.9); }
    .footer{ text-align:center; padding:8px 0 14px; font-size:0.8rem; color:rgba(255,255,255,0.35); }
    .inline-text{ font-size:0.8rem; color:rgba(200,220,240,0.8); }
  </style>
</head>

<body class="main-bg">
  <header class="nav">
    <div class="nav-logo">
      <div class="nav-logo-mark"></div>
      <div>
        <div class="nav-logo-text-main">DATA HAMMER GROUP</div>
        <div class="nav-logo-text-sub">Intelligent Talking System</div>
      </div>
    </div>
    <nav class="nav-links">
      <a href="/">首页</a>
      <a href="/chat_system">人机对话</a>
      <a href="/model_training">模型训练</a>
      <a href="/video_generation">视频生成</a>
      <a href="/实时对话.html">实时对话</a>
      <a href="/about">关于我们</a>
    </nav>
    <button class="nav-cta" onclick="window.location.href='/'">返回首页</button>
  </header>

  <main class="page-wrapper">
    <div class="page-inner">
      <div class="hero-card">
        <div class="badge"><div class="badge-dot"></div><span>REALTIME · DATA HAMMER TALKING SYSTEM</span></div>
        <h1 class="headline">实时对话界面 · <span>LIVE</span></h1>
        <p class="subline">使用本地麦克风与云端对话模型实时交流 · 语音输入 · 语音输出 · 低延迟</p>
        <div class="status-pill">
          <div id="statusDot" class="status-dot"></div>
          <span id="statusText">未连接</span>
        </div>
      </div>

      <div class="video-page-container">
        <div class="dialog-display">
          <div class="dialog-card">
            <div class="dialog-card-header">
              <span>对话记录 · Transcript</span>
              <span class="inline-text" id="latencyLabel">等待连接...</span>
            </div>
            <div id="chatLog" class="chat-log">
              <div class="chat-msg system">
                <span class="role">系统</span>
                <span class="content">点击右侧「连接 + 开始语音」按钮，允许浏览器使用麦克风，即可开始实时对话。</span>
              </div>
            </div>
            <div class="small-hint">提示：为了更好的麦克风权限体验，建议使用 Chrome / Edge，并在 HTTPS 下访问。</div>
          </div>
        </div>

        <div class="form-section">
          <div class="form-group">
            <label>WebSocket 网关地址（中转服务）</label>
            <input id="wsUrlInput" type="text" placeholder="">
            <div class="small-hint">
              默认使用 AutoDL 映射域名：wss://u811623-a935-f5308807.bjb1.seetacloud.com:8443/ws
            </div>
          </div>

          <div class="form-group">
            <label>文本输入（可选）</label>
            <textarea id="textInput" placeholder="在这里输入文字消息，也会通过同一个通道发送给模型。"></textarea>
            <div class="btn-row" style="margin-top:6px;">
              <button type="button" class="secondary-btn" id="sendTextBtn">发送文本</button>
              <button type="button" class="secondary-btn" id="clearLogBtn">清空记录</button>
            </div>
          </div>

          <div class="form-group">
            <label>实时语音控制</label>
            <div class="btn-row">
              <button type="button" class="primary-btn" id="startBtn">连接 + 开始语音</button>
              <button type="button" class="secondary-btn" id="stopBtn">停止对话</button>
            </div>
            <div class="small-hint">对话开始后，浏览器会持续推送本地麦克风音频到服务器，服务器调用云端模型并返回语音结果。</div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">© 2025 DATA HAMMER LAB · Realtime Talking · All Rights Reserved</footer>

  <script>
    // ====== WebSocket + WebAudio 实时语音逻辑 ======
    let ws = null, audioContext = null, micStream = null, processor = null;
    let playQueue = [], isPlaying = false;

    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const latencyLabel = document.getElementById('latencyLabel');
    const chatLog = document.getElementById('chatLog');
    const wsUrlInput = document.getElementById('wsUrlInput');
    const textInput = document.getElementById('textInput');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const sendTextBtn = document.getElementById('sendTextBtn');
    const clearLogBtn = document.getElementById('clearLogBtn');

    const SAMPLE_RATE = 16000;
    const BUFFER_SIZE = 1024;

    // 固定使用 AutoDL 的 WebSocket 域名（按你控制台实际域名改）
    const WS_URL = "wss://u811623-a935-f5308807.bjb1.seetacloud.com:8443/ws";

    function defaultWsUrl() {
      return WS_URL;
    }

    window.addEventListener('load', () => {
      if (!wsUrlInput) return;
      wsUrlInput.value = WS_URL;
      wsUrlInput.placeholder = WS_URL;
    });

    function setStatus(online, text) {
      if (online) {
        statusDot.classList.add('online');
        statusText.textContent = text || '已连接';
      } else {
        statusDot.classList.remove('online');
        statusText.textContent = text || '未连接';
      }
    }

    function appendMessage(role, content) {
      const msg = document.createElement('div');
      msg.className = 'chat-msg ' + role;
      const roleSpan = document.createElement('span');
      roleSpan.className = 'role';
      roleSpan.textContent = role === 'user' ? '用户' : role === 'assistant' ? '模型' : '系统';
      const contentSpan = document.createElement('span');
      contentSpan.className = 'content';
      contentSpan.textContent = content;
      msg.appendChild(roleSpan);
      msg.appendChild(contentSpan);
      chatLog.appendChild(msg);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    // Float32 [-1,1] -> Int16 PCM
    function floatTo16BitPCM(float32Array) {
      const buffer = new ArrayBuffer(float32Array.length * 2);
      const view = new DataView(buffer);
      for (let i = 0; i < float32Array.length; i++) {
        let s = Math.max(-1, Math.min(1, float32Array[i]));
        view.setInt16(i * 2, s < 0 ? s * 0x8000 : s * 0x7fff, true);
      }
      return buffer;
    }

    // 播放从服务器返回的 Int16 PCM
    function playAudioQueue() {
      if (!audioContext || playQueue.length === 0) { isPlaying = false; return; }
      isPlaying = true;
      const arrayBuffer = playQueue.shift();
      const int16 = new Int16Array(arrayBuffer);
      const float32 = new Float32Array(int16.length);
      for (let i = 0; i < int16.length; i++) float32[i] = int16[i] / 0x8000;

      const buffer = audioContext.createBuffer(1, float32.length, SAMPLE_RATE);
      buffer.copyToChannel(float32, 0);

      const source = audioContext.createBufferSource();
      source.buffer = buffer;
      source.connect(audioContext.destination);
      source.onended = () => { playAudioQueue(); };
      source.start();
    }

    async function startDialog() {
      if (ws) {
        appendMessage('system', 'WebSocket 已连接，无需重复连接。');
        return;
      }
      setStatus(false, '连接中...'); latencyLabel.textContent = '连接中...';

      const url = wsUrlInput.value.trim() || WS_URL;
      console.log('[WS URL used]', url);

      try {
        ws = new WebSocket(url);
        ws.binaryType = 'arraybuffer';

        ws.onopen = async () => {
          setStatus(true, '已连接 · 语音准备中');
          appendMessage('system', '已连接到中转服务：' + url);

          ws.send(JSON.stringify({ type: 'control', op: 'start' }));

          audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: SAMPLE_RATE });
          micStream = await navigator.mediaDevices.getUserMedia({
            audio: { channelCount: 1, echoCancellation: true, noiseSuppression: true, autoGainControl: true },
            video: false
          });
          const source = audioContext.createMediaStreamSource(micStream);
          processor = audioContext.createScriptProcessor(BUFFER_SIZE, 1, 1);
          source.connect(processor);

          // 将任意采样率的 Float32Array 下采样到目标采样率（简单线性平均）
          function downsampleBuffer(buffer, srcRate, dstRate) {
            if (dstRate === srcRate) return buffer;
            const sampleRateRatio = srcRate / dstRate;
            const newLength = Math.round(buffer.length / sampleRateRatio);
            const result = new Float32Array(newLength);
            let offsetResult = 0;
            let offsetBuffer = 0;
            while (offsetResult < newLength) {
              const nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
              let accum = 0, count = 0;
              for (let i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
                accum += buffer[i];
                count++;
              }
              result[offsetResult] = count > 0 ? accum / count : 0;
              offsetResult++;
              offsetBuffer = nextOffsetBuffer;
            }
            return result;
          }

          processor.onaudioprocess = (event) => {
            const inputBuffer = event.inputBuffer.getChannelData(0);
            const srcRate = audioContext.sampleRate || 48000;
            let float32Samples = inputBuffer;
            if (srcRate !== SAMPLE_RATE) {
              float32Samples = downsampleBuffer(inputBuffer, srcRate, SAMPLE_RATE);
            }
            const pcmBuffer = floatTo16BitPCM(float32Samples);
            if (ws && ws.readyState === WebSocket.OPEN) ws.send(pcmBuffer);
          };

          setStatus(true, '对话中'); latencyLabel.textContent = '推流中 · 正在实时对话';
        };

        ws.onmessage = (event) => {
          if (event.data instanceof ArrayBuffer) {
            playQueue.push(event.data);
            if (!isPlaying) playAudioQueue();
            return;
          }
          if (typeof event.data === 'string') {
            try {
              const obj = JSON.parse(event.data);
              if (obj.type === 'event' && obj.payload) {
                // payload 可能是文本或结构化内容
                appendMessage('assistant', typeof obj.payload === 'string' ? obj.payload : JSON.stringify(obj.payload));
                return;
              } else if (obj.type === 'control_ack') {
                appendMessage('system', `操作已确认: ${obj.op || ''}`);
                return;
              } else if (obj.type === 'error') {
                appendMessage('system', `错误: ${obj.message || ''}`);
                return;
              }
            } catch (e) {
              // 非 JSON 字符串，作为纯文本显示
            }
            appendMessage('assistant', event.data);
          }
        };

        ws.onclose = (e) => {
          appendMessage('system', `WebSocket 已关闭 code=${e.code} reason=${e.reason||''}`);
          setStatus(false, '连接已关闭'); latencyLabel.textContent = '连接已关闭';
          cleanup();
        };
        ws.onerror = (e) => {
          console.error('[WS error]', e);
          appendMessage('system', 'WebSocket 连接错误（浏览器日志见控制台）');
          setStatus(false, '连接错误'); latencyLabel.textContent = '连接错误';
        };
      } catch (e) {
        console.error(e);
        appendMessage('system', '建立连接失败：' + (e.message || e.toString()));
        setStatus(false, '连接失败'); latencyLabel.textContent = '连接失败';
        cleanup();
      }
    }

    function stopDialog() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        try { ws.send(JSON.stringify({ type: 'control', op: 'stop' })); } catch {}
        ws.close();
      } else {
        cleanup();
        setStatus(false, '未连接'); latencyLabel.textContent = '已停止';
      }
    }

    function cleanup() {
      if (processor) { processor.disconnect(); processor.onaudioprocess = null; processor = null; }
      if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
      if (audioContext) { audioContext.close(); audioContext = null; }
      if (ws) ws = null;
      playQueue = []; isPlaying = false;
    }

    function sendText() {
      const text = textInput.value.trim();
      if (!text) return;
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        appendMessage('system', '尚未连接 WebSocket，无法发送文本。');
        return;
      }
      ws.send(text);
      appendMessage('user', text);
      textInput.value = '';
    }

    function clearLog() {
      chatLog.innerHTML = '';
    }

    startBtn.addEventListener('click', startDialog);
    stopBtn.addEventListener('click', stopDialog);
    sendTextBtn.addEventListener('click', sendText);
    clearLogBtn.addEventListener('click', clearLog);
  </script>

</body>
</html>
